---
import BaseLayout from "./BaseLayout.astro";
import SideNav from '../components/SideNav.astro';
import { calculateReadingTime } from '../utils/readingTime';
import { resetFootnotes } from '../utils/footnotes';
import Footnotes from '../components/Footnotes.astro';

interface Props {
  title: string;
  description?: string;
  navItems?: Array<{ id: string; label: string }>;
  metadata?: Array<{ label: string; value?: string; values?: string[] }>;
  footnotes?: Array<{ id: string; text: string }>;
  backNavigation?: boolean;
  homeLinkText?: string;
}

const { 
  title, 
  description, 
  navItems = [], 
  metadata = [], 
  footnotes = [], 
  backNavigation = false,
  homeLinkText = "Index"
} = Astro.props;

// Reset footnote counter for this page
resetFootnotes();

// Calculate reading time from the content
const content = await Astro.slots.render('default');
const readingTime = calculateReadingTime(content);
---

<BaseLayout title={title}>
  <SideNav 
    navItems={navItems}
    showHomeLink={true}
    homeLinkText={homeLinkText}
    backNavigation={backNavigation}
  />

  <main class="project-main">
    <SideNav 
      variant="mobile"
      showHomeLink={true}
      homeLinkText={homeLinkText}
      backNavigation={backNavigation}
    />
    <header class="project-header">
        <div class="title-container">
          <h1>{title}</h1>
          <span class="reading-time">{readingTime} min read</span>
        </div>
        {description && <p>{description}</p>}
        
        {metadata.length > 0 && (
          <div class="project-metadata">
            {metadata.map(item => (
              <div class="metadata-entry">
                <div class="label">{item.label}</div>
                <div>
                  {item.values ? (
                    <>
                      {item.values.map(value => (
                        <div>{value}</div>
                      ))}
                    </>
                  ) : (
                    item.value
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
    </header>

    <article class="project-content">
      <slot />
    </article>

    <Footnotes footnotes={footnotes} />

  </main>
</BaseLayout>

<script>
  // Add project-section class to all sections within project-content
  document.addEventListener('DOMContentLoaded', () => {
    const projectContent = document.querySelector('.project-content');
    if (projectContent) {
      const sections = projectContent.querySelectorAll('section');
      sections.forEach(section => {
        section.classList.add('project-section');
      });
    }
  });
</script>

<style lang="scss">

  .project-main {
    margin-top: calc(var(--size-xxl) + var(--font-size-base) + var(--size-lg));

    @media (max-width: 1000px) {
        margin-top: var(--size-xxl);
    }
  }

  .project-header {
    display: flex;
    flex-direction: column;
    gap: var(--size-sm);

    .title-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--size-md);
      width: 100%;
    }

    h1 {
      font-size: var(--font-size-lg);
      color: var(--color-ink-primary);
    }

    .reading-time {
      font-size: var(--font-size-sm);
      color: var(--color-accent-dark);
      white-space: nowrap;
      background-color: var(--color-accent-light);
      padding: var(--size-xxxxs) var(--size-xs);
      border-radius: var(--border-radius-md);
    }

    .project-metadata {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--size-xl);
      margin-top: var(--size-md);

      @media (max-width: 1000px) {
        grid-template-columns: repeat(2, 1fr);
        row-gap: var(--size-sm);
    }
    }

    .metadata-entry {
      display: flex;
      flex-direction: column;
      gap: var(--size-xxs);
    }
  }
  
  .project-content {
    display: flex;
    flex-direction: column;
    gap: var(--size-xxxxl);
    max-width: 100%;
    margin: 0 auto;

    p {
      margin-top: 0;
      margin-bottom: var(--size-xs);
    }

    p + p {
      margin-top: var(--size-xxs);
    }

    img,
    .project-image {
      margin-top: var(--size-md);
      margin-bottom: var(--size-md);
      display: block;
    }

    article {
      scroll-margin-top: var(--size-xxl);
    }

    :global(.section-header) {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: baseline;
      gap: var(--size-xxxs);
      margin-bottom: var(--size-md);
    }

    :global(.section-heading) {
      display: block;
      scroll-margin-top: var(--size-xxl);
      transition: color var(--transition-smooth);
      margin-bottom: 0;

      &::after {
        display: none;
      }
    }
  }

  .project-content section {
    display: block !important;
  }

</style>