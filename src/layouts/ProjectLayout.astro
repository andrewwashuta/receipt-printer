---
import BaseLayout from "./BaseLayout.astro";
import SideNav from '../components/SideNav.astro';
import { calculateReadingTime } from '../utils/readingTime';
import { resetFootnotes } from '../utils/footnotes';
import Footnotes from '../components/Footnotes.astro';
import '../styles/global.scss';

interface Props {
  title: string;
  description?: string;
  navItems?: Array<{ id: string; label: string }>;
  metadata?: Array<{ label: string; value?: string; values?: string[] }>;
  footnotes?: Array<{ id: string; text: string }>;
  backNavigation?: boolean;
  homeLinkText?: string;
}

const { 
  title, 
  description, 
  navItems = [], 
  metadata = [], 
  footnotes = [], 
  backNavigation = false,
  homeLinkText = "Index"
} = Astro.props;

resetFootnotes();

const content = await Astro.slots.render('default');
const readingTime = calculateReadingTime(content);
---

<BaseLayout 
  title={title}
  description={description}
  image="/og.jpg"
  type="article"
>
  <SideNav 
    navItems={navItems}
    showHomeLink={true}
    homeLinkText={homeLinkText}
    backNavigation={backNavigation}
  />

  <main class="project-main">
    <SideNav 
      variant="mobile"
      showHomeLink={true}
      homeLinkText={homeLinkText}
      backNavigation={backNavigation}
    />
    <header class="project-header">
        <div class="title-container">
          <h1>{title}</h1>
          <span class="reading-time">{readingTime} min read</span>
        </div>
        {description && <p>{description}</p>}
        
        {metadata.length > 0 && (
          <div class="project-metadata">
            {metadata.map(item => (
              <div class="metadata-entry">
                <div class="label">{item.label}</div>
                <div>
                  {item.values ? (
                    <>
                      {item.values.map(value => (
                        <div>{value}</div>
                      ))}
                    </>
                  ) : (
                    item.value
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
    </header>

    <article class="project-content">
      <slot />
    </article>

    <Footnotes footnotes={footnotes} />

  </main>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const projectContent = document.querySelector('.project-content');
    if (projectContent) {
      const sections = projectContent.querySelectorAll('section');
      sections.forEach(section => {
        section.classList.add('project-section');
      });
    }
  });
</script>

<style lang="scss">
@use '../styles/global.scss' as *;

  .project-main {
    margin-top: calc(var(--size-xxl) + var(--font-size-base) + var(--size-xl));
    max-width: calc(700px + (var(--size-lg) * 2));

    @include mobile {
        margin-top: var(--size-xxl);
        gap: var(--size-xxxl);
        max-width: 748px;
    }
  }

  .project-header {
    display: flex;
    flex-direction: column;
    gap: var(--size-sm);
    padding: 0 var(--size-lg);

    @include mobile {
      padding: 0;
    }

    .title-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--size-md);
      width: 100%;
    }

    h1 {
      font-size: var(--font-size-lg);
      color: var(--color-ink-primary);
    }

    .reading-time {
      font-size: var(--font-size-sm);
      color: var(--color-accent-dark);
      white-space: nowrap;
      background-color: var(--color-accent-light);
      padding: var(--size-xxxxs) var(--size-xs);
      border-radius: var(--border-radius-md);
    }

    .project-metadata {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--size-xl);
      margin-top: var(--size-md);

      @include mobile {
        grid-template-columns: repeat(2, 1fr);
        row-gap: var(--size-sm);
    }
    }

    .metadata-entry {
      display: flex;
      flex-direction: column;
      gap: var(--size-xxs);
    }
  }
  
  .project-content {
    display: flex;
    flex-direction: column;
    gap: var(--size-xxxxl);
    max-width: 100%;
    margin: 0 auto;

    @include mobile {
      gap: var(--size-xxxl);
    }

    img,
    .project-image {
      margin-top: var(--size-md);
      margin-bottom: var(--size-md);
      display: block;
    }

    article {
      scroll-margin-top: var(--size-xxl);
    }

    :global(.section-heading) {
      display: block;
      scroll-margin-top: var(--size-xxl);
      transition: color var(--transition-smooth);
      margin-bottom: 0;

      &::after {
        display: none;
      }
    }

    :global(p){
      padding: 0 var(--size-lg);

      @include mobile {
        padding: 0;
    }
    }

    :global(.section-header) {
      padding: 0 var(--size-lg);
      
      @include mobile {
        padding: 0;
    }
    }
  }

  .project-content section {
    display: block !important;
  }

:global(.metrics-grid) {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--size-md);
  margin: var(--size-lg) 0;
  width: 100%;
  padding: 0 var(--size-lg);

  @include mobile {
    padding: 0;
  }

  &:last-child {
    margin-bottom: 0;
  }

  &:has(> :only-child) {
    grid-template-columns: 1fr;
  }
}

:global(.metric) {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: var(--size-xxs);
}

:global(.metric-value) {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-normal);
  color: var(--color-ink-primary);
  line-height: 1.2;
}

</style>